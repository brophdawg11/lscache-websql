!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.lscacheWebsql=b()}(this,function(){function a(a){var b=Array.prototype.slice.call(arguments,1);return function(){var c=Array.prototype.slice.call(arguments,0);return a.apply(null,b.concat(c))}}function b(){return d("DROP TABLE "+v,[]).then(function(a,b){return(new $.Deferred).resolve(a,b)},function(a){return(new $.Deferred).resolve(a,null)})}function c(){return d("CREATE TABLE "+v+" ("+w+" unique, "+x+")")}function d(a,b){var c=new $.Deferred;return k("Executing sql: "+a),k(b),m.transaction(function(d){d.executeSql(a,b,function(a,b){c.resolve(b)},function(a,b){c.reject(b)})}),c.promise().fail(function(a){k("tx.executeSql failed: "+a.message)})}function e(){return void 0===l&&(l=null!=window.JSON),l}function f(a){return a+n}function g(){return Math.floor((new Date).getTime()/p)}function h(b){var c=a(d,"SELECT "+x+" FROM "+v+" WHERE "+w+" = ?",[b]);return y.then(c)}function i(b,c){var e=a(d,"INSERT INTO "+v+" ("+w+", "+x+") VALUES (?, ?)",[b,c]);return y.then(e)}function j(b){var c=a(d,"DELETE FROM "+v+" WHERE "+w+" = ?",[b]);return y.then(c)}function k(a,b){q&&"console"in window&&"function"==typeof window.console.warn&&(window.console.warn("lscacheWebsql - "+a),b&&window.console.warn("lscacheWebsql - The error was: "+b.message))}var l,m,n="-cacheexpiration",o=10,p=6e4,q=!1,r="__lscache-websql__",s="1.0",t="lscache-websql db",u=10485760,v="data",w="keyx",x="valx",y=new $.Deferred;"openDatabase"in window?(m=openDatabase(r,s,t,u),b().then(c).done(y.resolve).fail(y.reject)):y.reject("openDatabase not defined!");var z={set:function(a,b,c){return y.then(function(){function d(b){return c?i(f(a),(g()+c).toString(o)).then(function(){return b}).fail(function(){return j(a)}):(new $.Deferred).resolve(b).done(function(){return j(f(a))})}var h;if("string"!=typeof b){if(!e())return h="Unable to stringify non-string value, ignoring",k(h),(new $.Deferred).reject(h);try{b=JSON.stringify(b)}catch(l){return h="Unable to stringify circular references, ignoring",k(h),(new $.Deferred).reject(h)}}try{return i(a,b).then(d)}catch(l){return h="Could not add item with key '"+a+"'",k(h,l),(new $.Deferred).reject(h)}})},isExpired:function(a){return y.then(function(){var b=f(a);return h(b).then(function(a){try{var b=a.rows.item(0)[x];if(b){var c=parseInt(b,o);if(g()>=c)return!0}}catch(d){}return!1})})},get:function(a,b,c){return b=b===!0,c=c===!0,y.then(function(){return z.isExpired(a).then(function(d){var g=new $.Deferred,i=(new $.Deferred).resolve();if(d){if(!b){var k=f(a);i=i.then(function(){return h(a).then(g.resolve,g.reject)}).then(function(){return j(a)}).then(function(){return j(k)})}if(!c)return null}return i=i.then(function(){function b(a){var b=null;try{return b=a.rows.item(0)[x],b&&e()?JSON.parse(b):b}catch(c){return b}}return"pending"===g.state()?h(a).then(b):g.then(b)}),i.promise()})})},remove:function(a){return y.then(function(){j(a)}).then(function(){j(f(a))})},supported:function(){return y.then(function(){return!0},function(){return!1})},flush:function(){return y.then(a(d,"DELETE FROM "+v,[]))},enableWarnings:function(a){q=a}};return z});